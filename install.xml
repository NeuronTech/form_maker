<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--NOTICE: Please open this file in your web browser. If presented with a security warning, you may safely tell it to allow the blocked content.-->
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD.\nAlthough MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD.\nNo support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.5.xsd">
	<header>
		<meta name="generator" content="MODX file generated by MODX Generator by tumba25"/>
		<license><![CDATA[http://opensource.org/licenses/gpl-license.php GNU General Public License v2...]]></license>
		<title lang="en"><![CDATA[Form Builder (aka phpBB3 Form Creator)]]></title>
		<description lang="en"><![CDATA[This mod allows admin to create a Form for the collection of data in any forums where a from would be the preferred method of collecting precise... A couple of examples might be, a Bug Report or Review Forum...

		In the ACP you can create, edit, delete and manage forms...
		
		If a form exist for a given forum the member will have the option to use the Form Mode in place of the normal text post method...
		
		The form is automatically assigned to a forum on creation and is available for use by your members by selecting the option during posting a new post...
		]]></description>
		<author-notes lang="en"><![CDATA[Most of the credit for this mod goes to Sajaki @ www.bbdkp.com for his Appform Mod (A phpBB3 MOD).
		The original Form Maker mod was rewritten to encompass the Appform code, albeit slightly alter and extended...
		
		Validation of form data relies on HTML5 (client side validation) and is supported in Firefox, Opera, Chrome, IE 10 and other browsers (Safari does not currently support HTML5 form validation)... If the forms are used to collect crucial data, you may wish to add your own javascript validation code....]]></author-notes>

	<author-group>
		<author>
			<username>michaelo</username>
			<realname>Michael O'Toole</realname>
			<homepage>http://www.phpbbreland.com/</homepage>
			<email>o2l@eircom.net</email>
		</author>
	</author-group>

	<mod-version lang="en"><![CDATA[0.0.1]]></mod-version>

	<installation>
		<level>intermediate</level>
		<time>2003</time>
		<target-version>3.0.10</target-version>
	</installation>

	<history>
		<entry>
			<date>2012-07-04</date>
			<rev-version>0.0.1</rev-version>
			<changelog lang="en">
				<change>No changes... first version...</change>
			</changelog>
		</entry>
	</history>


	</header>
	<action-group>
		<copy>
			<file from="root/adm/images/icon_hide.gif" to="adm/images/icon_hide.gif"/>
			<file from="root/adm/images/icon_show.gif" to="adm/images/icon_show.gif"/>
			<file from="root/adm/images/loading-page.gif" to="adm/images/loading-page.gif"/>
			<file from="root/adm/style/acp_form_maker.html" to="adm/style/acp_form_maker.html"/>
			<file from="root/adm/style/jquery-1.7.1.min.js" to="adm/style/jquery-1.7.1.min.js"/>
			<file from="root/adm/style/forms/form_maker.html" to="adm/style/forms/form_maker.html"/>
			<file from="root/includes/acp/acp_form_maker.php" to="includes/acp/acp_form_maker.php"/>
			<file from="root/includes/acp/info/acp_form_maker.php" to="includes/acp/info/acp_form_maker.php"/>
			<file from="root/language/en/mods/form_maker_install_umil.php" to="language/en/mods/form_maker_install_umil.php"/>
			<file from="root/language/en/mods/form_maker.php" to="language/en/mods/form_maker.php"/>
			<file from="root/language/en/mods/info_acp_form_maker.php" to="language/en/mods/info_acp_form_maker.php"/>
			<file from="root/styles/prosilver/template/portal.js" to="styles/prosilver/template/portal.js"/>
			<file from="root/styles/prosilver/template/forms/form_maker.html" to="styles/prosilver/template/forms/form_maker.html"/>
			<file from="root/umil/*.*" to="umil/*.*" />
			<file from="root/form_maker_install/*.*" to="form_maker_install/*.*"/>
		</copy>
		<open src="posting.php">
			<edit>
				<find><![CDATA[$auth->acl($user->data);]]></find>
				<action type="after-add"><![CDATA[$user->add_lang('mods/form_maker');]]></action>
			</edit>
			<edit>
				<find><![CDATA[if ($submit || $preview || $refresh)
{]]></find>
				<action type="after-add"><![CDATA[	$message = utf8_normalize_nfc(request_var('message', '', true));
	if ($message === '')
	{
		$message = grab_form_data($forum_id);
	}]]></action>
			</edit>
			<edit>
				<find><![CDATA[	$message_parser->message		= utf8_normalize_nfc(request_var('message', '', true));]]></find>
				<inline-edit>
					<inline-find><![CDATA[	$message_parser->message		= ]]></inline-find>
					<inline-action type="after-add"><![CDATA[$message; //]]></inline-action>
				</inline-edit>
			</edit>
			<edit>
				<find><![CDATA[		$template->assign_var('S_DISPLAY_REVIEW', true);
	}
}]]></find>
				<action type="after-add"><![CDATA[build_form($forum_id);]]></action>
			</edit>
			<edit>
				<find><![CDATA[	trigger_error('USER_CANNOT_DELETE');]]></find>
				<action type="after-add"><![CDATA[}

/***
* I use html5 form validation here but only Firefox, Opera, Chrome and IE 10 currently support it...
*
***/

function build_form($forum_id)
{
	global $db, $template, $mode;

	$sql = "SELECT id, form_id, ndx_order, name, hint, type, mandatory, options, forum_name, forum_id
		FROM " . FORM_MAKER_TABLE . " AS m, " . FORUMS_TABLE . " AS f
		WHERE m.form_id = '" . $forum_id . "'
		AND m.form_id = f.forum_id
		ORDER BY ndx_order";

	$result = $db->sql_query($sql);

	while ($row = $db->sql_fetchrow($result))
	{
		$req = '';

		switch($row['type'])
		{
			case 'Inputbox':

				if($row['mandatory'])
				{
					$req = 'required="required"';
				}

				$type = '<input style="border-radius: 5px;" class="text" style="width:300px;"
				type="text" name="templatefield_' . $row['ndx_order'] . '"
				placeholder="' . $row['hint'] . '"
				size="40" maxlength="60" tabindex="' . $row['ndx_order'] . '" ' . $req . ' />';
				break;

			case 'Textbox':
				if($row['mandatory'])
				{
					$req = 'required="required"';
				}

				$type = '<textarea style="border-radius: 5px;" class="text" name="templatefield_' . $row['ndx_order'] . '" rows="3" cols="76"
				tabindex="' . $row['ndx_order'] . '" onselect="storeCaret(this);"
				$req
				onclick="storeCaret(this);"
				placeholder="' . $row['hint'] . '"
				onkeyup="storeCaret(this);" ></textarea>';
				break;

			case 'Selectbox':
				if($row['mandatory'])
				{
					$req = 'required="required"';
				}

			    $type = '<select style="border-radius: 5px;" class="inputbox" name="templatefield_' . $row['ndx_order'] . '" ' . $req. ' tabindex="' . $row['ndx_order'] . '">';
			    $type .= '<option value="">----------------</option>';
			         $select_option = explode(',', $row['options']);
			         foreach($select_option as $value)
			         {
			             $type .='<option value="'. $value .'">'. $value .'</option>';
			         }
			    $type .= '</select>';
				break;

			case 'Radiobuttons':
				if($row['mandatory'])
				{
					$req = 'required="required"';
				}

			    $radio_option = explode(',', $row['options']);

			    $type = '';
			    foreach($radio_option as $value)
			    {
			       $type .='<input type="radio" name="templatefield_'. $row['ndx_order'] .'" ' . $req . ' value="'. $value .'"/>&nbsp;'. $value .'&nbsp;&nbsp;';
			    }
				break;

			case 'Checkboxes':
				if($row['mandatory'])
				{
					$req = 'required="required"';
				}

		        $check_option = explode(',', $row['options']);

		        $type = '';
		        foreach($check_option as $value)
		        {
		           $type .='<input type="checkbox" name="templatefield_'. $row['ndx_order'] .'[]"' . $req . ' value="'. $value .'"/>&nbsp;'. $value .'&nbsp;&nbsp;';
		        }
				break;
		}

		$mandatory = '';

		if ($row['mandatory'] == '1')
		{
			//$mandatory = '&nbsp;<span style="color:red">' . $user->lang['MANDATORY']. '</span>';
			$mandatory = '&nbsp;<span style="color:red">' . '*' . '</span>';
		}

		$template->assign_block_vars('form_apptemplate', array(
			'NDX_ORDER'		=> $row['ndx_order'],
			'NAME'			=> $row['name'],
			'HINT'		    => $row['hint'],
			'OPTIONS'   	=> $row['options'],
			'TYPE'			=> $type,
			'MANDATORY' 	=> $mandatory)
		);
		$template->assign_vars(array(
			'MODE'	=> $mode
		));

	}
	$db->sql_freeresult($result);
}
function grab_form_data($forum_id)
{
	global $auth, $config, $db, $user, $phpbb_root_path, $phpEx;

	$appform_post = '';

	$config['title_colour'] = (isset($config['title_colour'])) ? $config['title_colour'] : '#FF0000';

	$sql = "SELECT *
		FROM " . FORM_MAKER_TABLE . "
		WHERE form_id = " . $forum_id . "
		ORDER BY ndx_order";

	$result = $db->sql_query_limit($sql, 100, 0);

	while ( $row = $db->sql_fetchrow($result) )
	{
		if ( isset($_POST['templatefield_' . $row['ndx_order']]) )
		{
			switch ($row['type'])
			{
				case 'Checkboxes':
					 $cb_countis = count( request_var('templatefield_' . $row['ndx_order'], array(0 => 0)) );
                     $cb_count = 0;

                        $appform_post .= '[size=110][color='. $config['title_colour'] .'][b]' . $row['name'] . ': [/b][/color][/size]';
						$appform_post .= '<br />';

                        $checkboxes = utf8_normalize_nfc( request_var('templatefield_' . $row['ndx_order'], array(0 => '') , true));
                        foreach($checkboxes as $value)
                        {
                            $appform_post .= $value;
                            if ($cb_count < $cb_countis-1)
                            {
                                $appform_post .= ',  ';
                            }
                            $cb_count++;
                        }
                        $appform_post .= '<br /><br />';

					break;
				case 'Inputbox':
				case 'Textbox':
				case 'Selectbox':
				case 'Radiobuttons':
					$fieldcontents = utf8_normalize_nfc(request_var('templatefield_' . $row['ndx_order'], ' ', true));

					$appform_post .= '[size=110][color='. $config['title_colour'] .'][b]' . $row['name'] . ': [/b][/color][/size]';
					$appform_post .= '<br />';

					$appform_post .=	$fieldcontents;

					$appform_post .= '<br /><br />';
					break;
			}

		}
	}
	$db->sql_freeresult($result);
	return('[tab] ' . $appform_post . ' [/tab]');]]></action>
			</edit>
		</open>
		<open src="viewtopic.php">
			<edit>
				<find><![CDATA[// now I have the urge to wash my hands :(]]></find>
				<action type="after-add"><![CDATA[build_review($forum_id);

function build_review($forum_id)
{
	global $db, $template;

	$sql = "SELECT id, form_id, ndx_order, name, hint, type, mandatory, options, forum_name, forum_id
		FROM " . FORM_MAKER_TABLE . " AS m, " . FORUMS_TABLE . " AS f
		WHERE m.form_id = '" . $forum_id . "'
		AND m.form_id = f.forum_id
		ORDER BY ndx_order";

	$result = $db->sql_query($sql);

	while ($row = $db->sql_fetchrow($result))
	{
		switch($row['type'])
		{
			case 'Inputbox':
				$type = '<input style="border-radius: 5px;" class="text" style="width:300px;"
				type="text" name="templatefield_' . $row['ndx_order'] . '"
				placeholder="' . $row['hint'] . '"
				size="40" maxlength="60" tabindex="' . $row['ndx_order'] . '" />';
				break;
			case 'Textbox':
				$type = '<textarea style="border-radius: 5px;" class="text" name="templatefield_' . $row['ndx_order'] . '" rows="3" cols="76"
				tabindex="' . $row['ndx_order'] . '" onselect="storeCaret(this);"
				onclick="storeCaret(this);"
				placeholder="' . $row['hint'] . '"
				onkeyup="storeCaret(this);" ></textarea>';
				break;
			case 'Selectbox':
			    $type = '<select style="border-radius: 5px;" class="inputbox" name="templatefield_' . $row['ndx_order'] . '" tabindex="' . $row['ndx_order'] . '">';
			    $type .= '<option value="">----------------</option>';
			         $select_option = explode(',', $row['options']);
			         foreach($select_option as $value)
			         {
			             $type .='<option value="'. $value .'">'. $value .'</option>';
			         }
			    $type .= '</select>';
				break;
			case 'Radiobuttons':
			    $radio_option = explode(',', $row['options']);

			    $type = '';
			    foreach($radio_option as $value)
			    {
			       $type .='<input type="radio" name="templatefield_'. $row['ndx_order'] .'" value="'. $value .'"/>&nbsp;'. $value .'&nbsp;&nbsp;';
			    }
				break;
			case 'Checkboxes':
		        $check_option = explode(',', $row['options']);

		        $type = '';
		        foreach($check_option as $value)
		        {
		           $type .='<input type="checkbox" name="templatefield_'. $row['ndx_order'] .'[]" value="'. $value .'"/>&nbsp;'. $value .'&nbsp;&nbsp;';
		        }
				break;
		}

		$mandatory = '';

		if ($row['mandatory'] == '1')
		{
			//$mandatory = '&nbsp;<span style="color:red">' . $user->lang['MANDATORY']. '</span>';
			$mandatory = '&nbsp;<span style="color:red">' . '*' . '</span>';
		}

		$template->assign_block_vars('form_apptemplate', array(
			'NDX_ORDER'		=> $row['ndx_order'],
			'NAME'			=> $row['name'],
			'HINT'		    => $row['hint'],
			'OPTIONS'   	=> $row['options'],
			'TYPE'			=> $type,
			'MANDATORY' 	=> $mandatory)
		);

	}
	$db->sql_freeresult($result);
}]]></action>
			</edit>
		</open>

		<open src="includes/constants.php">
			<edit>
				<find><![CDATA[// Additional tables]]></find>
				<action type="after-add"><![CDATA[		define('FORM_MAKER_TABLE',          $table_prefix . 'form_maker');]]></action>
			</edit>
		</open>

		<open src="adm/style/acp_mods.html">
			<edit>
				<find><![CDATA[			<input class="button2" type="submit" name="force" value="{L_FORCE_INSTALL}" onclick="javascript:return confirm('{LA_FORCE_CONFIRM}'); " />]]></find>
				<find><![CDATA[			{S_FORM_TOKEN}]]></find>
				<action type="replace-with"/>
			</edit>
		</open>
		<open src="adm/style/admin.css">
			<edit>
				<find><![CDATA[	font-size: x-small;]]></find>
				<action type="after-add"><![CDATA[/*]]></action>
			</edit>
			<edit>
				<find><![CDATA[	voice-family: inherit;]]></find>
				<action type="after-add"><![CDATA[*/]]></action>
			</edit>
			<edit>
				<find><![CDATA[.phpinfo td, .phpinfo th, .phpinfo h2, .phpinfo h1 {
	text-align: left;]]></find>
				<action type="after-add"><![CDATA[}


/* Form Maker Mod */
.checkbox {cursor:pointer}
#dvLoading
{
   background: transparent url("../images/loading-page.gif") no-repeat center center;
   height: 100px;
   width: 100px;
   position: fixed;
   z-index: 1000;
   left: 50%;
   top:13%;]]></action>
			</edit>
		</open>

		<open src="language/en/viewtopic.php">
			<edit>
				<find><![CDATA[	'LOGIN_VIEWTOPIC'		=> 'The board requires you to be registered and logged in to view this topic.',]]></find>
				<action type="after-add"><![CDATA[	'MANDATORY'             => 'Items marked with the asterisk are mandatory (they cannot be empty)...',]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/posting_buttons.html">
			<edit>
				<find><![CDATA[<script type="text/javascript" src="{T_SUPER_TEMPLATE_PATH}/editor.js"></script>]]></find>
				<action type="after-add"><![CDATA[<script type="text/javascript" src="{T_SUPER_TEMPLATE_PATH}/portal.js"></script>]]></action>
			</edit>
			<edit>
				<find><![CDATA[<div id="format-buttons">]]></find>
				<action type="after-add"><![CDATA[	<!-- IF MODE == 'post' -->
	<input type="button" class="button2" accesskey="f" name="useform" value="{L_OPEN_FORM}" style="font-weight:normal; width: 50px" onclick="ShowHide('thisform','message-box');ShowHide('smiley-box','format-buttons');ShowHide('form_hide');" title="{L_OPEN_FORM_EXPLAIN}" />
	<!-- ELSEIF MODE == 'edit' -->
	<!--<input type="button" class="button2" accesskey="f" name="saveform" value="{L_CLOSE_FORM}" style="font-weight:normal; width: 50px" onclick="ShowHide('thisform','message-box');ShowHide('smiley-box','format-buttons');Message_To_Form();" title="{L_OPEN_FORM_EXPLAIN}" />-->
	<!-- ENDIF -->]]></action>
			</edit>
			<edit>
				<find><![CDATA[</div>]]></find>
				<action type="after-add"><![CDATA[<!-- IF MODE == 'edit' --><div class="form_help">{L_FORM_HELP_1}</div><!-- ENDIF -->]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/posting_editor.html">
			<edit>
				<find><![CDATA[			</fieldset>

			<span class="corners-bottom"><span></span></span></div>
		</div>
	<!-- ENDIF -->]]></find>
				<action type="after-add"><![CDATA[
<!-- INCLUDE forms/form_maker.html -->]]></action>
			</edit>
			<edit>
				<find><![CDATA[	<div class="panel bg2">]]></find>
				<inline-edit>
					<inline-find><![CDATA[	<div]]></inline-find>
					<inline-action type="after-add"><![CDATA[ id="form_hide"]]></inline-action>
				</inline-edit>
			</edit>
		</open>
		<php-installer><![CDATA[form_maker_install/index.php]]></php-installer>
		<diy-instructions lang="en-gb"><![CDATA[Add your DIY instructions here....]]></diy-instructions>
	</action-group>
</mod>
